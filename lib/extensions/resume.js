"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var debug = require('debug')('ratatoskr:resume');
var RESUME_STEPS = [200, 1 * 1000, 5 * 1000, 10 * 1000, 30 * 1000, 60 * 1000];
function resume(_a) {
    var _b = _a === void 0 ? {} : _a, _c = _b.ping, ping = _c === void 0 ? 10 * 1000 : _c, _d = _b.retry, retry = _d === void 0 ? 6 : _d, _e = _b.steps, steps = _e === void 0 ? RESUME_STEPS : _e, _f = _b.jitter, jitter = _f === void 0 ? 1800 : _f;
    return function (client) {
        var prevAckAt, thisAckAt;
        var pingTimeout;
        var resumeTimeout;
        var resumeAttempts = 0;
        function doPing() {
            var msg = {};
            client.emit('resume:ping', msg);
            debug('ping=', msg);
            client.sendPing().then(function (ack) {
                debug('pong=', ack);
                prevAckAt = thisAckAt, thisAckAt = Date.now();
                client.emit('resume:pong', ack);
                client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
                pingTimeout = setTimeout(function () { return doPing(); }, ping);
            }, function (err) {
                debug('error=', err);
                if (resumeAttempts === 0) {
                    client.disconnect(new Error('pong'));
                }
            });
        }
        function doResume() {
            resumeAttempts++;
            if (retry > -1 && resumeAttempts > retry) {
                debug('quit');
                client.emit('resume:quit');
                return;
            }
            var resumeDelay = steps[Math.min(resumeAttempts, steps.length) - 1];
            debug('attempt=', resumeAttempts, resumeDelay);
            client.emit('resume', resumeDelay, resumeAttempts);
            clearTimeout(resumeTimeout), resumeTimeout = null;
            resumeTimeout = setTimeout(function () { return client.connect(); }, resumeDelay);
        }
        client.on('authenticated', function () {
            debug('authenticated');
            prevAckAt = thisAckAt || Date.now(), thisAckAt = Date.now();
            client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
            pingTimeout = setTimeout(function () { return doPing(); }, ping);
            resumeAttempts = 0;
        });
        client.on('disconnected', function (reason) {
            debug('disconnected reason=', reason);
            clearTimeout(pingTimeout), pingTimeout = null;
            if (reason === client) {
                debug('stop');
                clearTimeout(resumeTimeout), resumeTimeout = null;
                if (resumeAttempts > 0) {
                    client.emit('resume:stop');
                }
                resumeAttempts = 0;
                return;
            }
            if (jitter > 0 && resumeAttempts === 0) {
                var randomized = jitter * Math.random();
                debug('jitter first resume attempt=', randomized);
                setTimeout(function () { return doResume(); }, randomized);
            }
            else {
                doResume();
            }
        });
    };
}
exports.resume = resume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2V4dGVuc2lvbnMvcmVzdW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsSUFBTSxLQUFLLEdBQW9CLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3BFLElBQU0sWUFBWSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLEVBQUUsR0FBRyxJQUFJLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBU2hGLGdCQUF1QixFQUF3RjtRQUF4Riw0QkFBd0YsRUFBdEYsWUFBZ0IsRUFBaEIscUNBQWdCLEVBQUUsYUFBUyxFQUFULDhCQUFTLEVBQUUsYUFBb0IsRUFBcEIseUNBQW9CLEVBQUUsY0FBYSxFQUFiLGtDQUFhO0lBQ3JGLE1BQU0sQ0FBQyxVQUFDLE1BQWM7UUFDbEIsSUFBSSxTQUFpQixFQUFFLFNBQWlCLENBQUM7UUFDekMsSUFBSSxXQUFnQixDQUFDO1FBQ3JCLElBQUksYUFBa0IsQ0FBQztRQUN2QixJQUFJLGNBQWMsR0FBVyxDQUFDLENBQUM7UUFFL0I7WUFDSSxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDYixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUVoQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRXBCLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQyxHQUFHO2dCQUN2QixLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUVwQixTQUFTLEdBQUcsU0FBUyxFQUFFLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQzlDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdB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LENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxJQUFNLFVBQVUsR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUMxQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQ2xELFVBQVUsQ0FBQyxjQUFNLE9BQUEsUUFBUSxFQUFFLEVBQVYsQ0FBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzdDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixRQUFRLEVBQUUsQ0FBQztZQUNmLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztBQUNOLENBQUM7QUF4RkQsd0JBd0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSAnLi4vY2xpZW50JztcclxuXHJcbmNvbnN0IGRlYnVnOiBkZWJ1Zy5JRGVidWdnZXIgPSByZXF1aXJlKCdkZWJ1ZycpKCdyYXRhdG9za3I6cmVzdW1lJyk7XHJcbmNvbnN0IFJFU1VNRV9TVEVQUyA9IFsyMDAsIDEgKiAxMDAwLCA1ICogMTAwMCwgMTAgKiAxMDAwLCAzMCAqIDEwMDAsIDYwICogMTAwMF07IC8vIDBzLCAxcywgNXMsIDEwcywgMzBzLCA2MHNcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVzdW1lT3B0aW9ucyB7XHJcbiAgICBwaW5nPzogbnVtYmVyO1xyXG4gICAgcmV0cnk/OiBudW1iZXI7XHJcbiAgICBzdGVwcz86IEFycmF5PG51bWJlcj47XHJcbiAgICBqaXR0ZXI/OiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZXN1bWUoeyBwaW5nID0gMTAgKiAxMDAwLCByZXRyeSA9IDYsIHN0ZXBzID0gUkVTVU1FX1NURVBTLCBqaXR0ZXIgPSAxODAwIH06IFJlc3VtZU9wdGlvbnMgPSB7fSkge1xyXG4gICAgcmV0dXJuIChjbGllbnQ6IENsaWVudCkgPT4ge1xyXG4gICAgICAgIHZhciBwcmV2QWNrQXQ6IG51bWJlciwgdGhpc0Fja0F0OiBudW1iZXI7XHJcbiAgICAgICAgdmFyIHBpbmdUaW1lb3V0OiBhbnk7XHJcbiAgICAgICAgdmFyIHJlc3VtZVRpbWVvdXQ6IGFueTtcclxuICAgICAgICB2YXIgcmVzdW1lQXR0ZW1wdHM6IG51bWJlciA9IDA7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGRvUGluZygpIHtcclxuICAgICAgICAgICAgdmFyIG1zZyA9IHt9O1xyXG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnBpbmcnLCBtc2cpO1xyXG5cclxuICAgICAgICAgICAgZGVidWcoJ3Bpbmc9JywgbXNnKTtcclxuXHJcbiAgICAgICAgICAgIGNsaWVudC5zZW5kUGluZygpLnRoZW4oKGFjaykgPT4ge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoJ3Bvbmc9JywgYWNrKTtcclxuXHJcbiAgICAgICAgICAgICAgICBwcmV2QWNrQXQgPSB0aGlzQWNrQXQsIHRoaXNBY2tBdCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnBvbmcnLCBhY2spO1xyXG4gICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTp0aWNrJywgdGhpc0Fja0F0IC0gcHJldkFja0F0LCB0aGlzQWNrQXQsIHByZXZBY2tBdCk7XHJcbiAgICAgICAgICAgICAgICBwaW5nVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gZG9QaW5nKCksIHBpbmcpO1xyXG4gICAgICAgICAgICB9LCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZygnZXJyb3I9JywgZXJyKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgc29ja2V0IGlzIGNsb3NlZCwgaXQgd2lsbCB0cmlnZ2VyIGEgYGRpc2Nvbm5lY3RlZGAgZXZlbnQsIHdoaWNoIHdpbGwgaW4gdHVybiB0cmlnZ2VyIGBkb1Jlc3VtZWAsIGFuZCB0aGVuIGFueSBtZXNzYWdlc1xyXG4gICAgICAgICAgICAgICAgLy8gYXdhaXRpbmcgYWNrbm93bGVkZ2VtZW50IHdpbGwgYmUgcmVqZWN0ZWQuICBJbiB0aGlzIG9yZGVyIG9mIGV2ZW50cywgdGhlIHJlc3VtZSBwcm9jZXNzIGhhcyBhbHJlYWR5IGJlZ3VuLCBzbyB3ZSBkbyBub3Qgd2FudCB0b1xyXG4gICAgICAgICAgICAgICAgLy8gZGlzY29ubmVjdCBoZXJlLlxyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VtZUF0dGVtcHRzID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LmRpc2Nvbm5lY3QobmV3IEVycm9yKCdwb25nJykpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGRvUmVzdW1lKCkge1xyXG4gICAgICAgICAgICByZXN1bWVBdHRlbXB0cysrO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJldHJ5ID4gLTEgJiYgcmVzdW1lQXR0ZW1wdHMgPiByZXRyeSkge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoJ3F1aXQnKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnF1aXQnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdmFyIHJlc3VtZURlbGF5ID0gc3RlcHNbTWF0aC5taW4ocmVzdW1lQXR0ZW1wdHMsIHN0ZXBzLmxlbmd0aCkgLSAxXTtcclxuXHJcbiAgICAgICAgICAgIGRlYnVnKCdhdHRlbXB0PScsIHJlc3VtZUF0dGVtcHRzLCByZXN1bWVEZWxheSk7XHJcblxyXG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lJywgcmVzdW1lRGVsYXksIHJlc3VtZUF0dGVtcHRzKTtcclxuXHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXN1bWVUaW1lb3V0KSwgcmVzdW1lVGltZW91dCA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICByZXN1bWVUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiBjbGllbnQuY29ubmVjdCgpLCByZXN1bWVEZWxheSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbGllbnQub24oJ2F1dGhlbnRpY2F0ZWQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGRlYnVnKCdhdXRoZW50aWNhdGVkJyk7XHJcblxyXG4gICAgICAgICAgICBwcmV2QWNrQXQgPSB0aGlzQWNrQXQgfHwgRGF0ZS5ub3coKSwgdGhpc0Fja0F0ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTp0aWNrJywgdGhpc0Fja0F0IC0gcHJldkFja0F0LCB0aGlzQWNrQXQsIHByZXZBY2tBdCk7XHJcbiAgICAgICAgICAgIHBpbmdUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiBkb1BpbmcoKSwgcGluZyk7XHJcbiAgICAgICAgICAgIHJlc3VtZUF0dGVtcHRzID0gMDtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY2xpZW50Lm9uKCdkaXNjb25uZWN0ZWQnLCAocmVhc29uKSA9PiB7XHJcbiAgICAgICAgICAgIGRlYnVnKCdkaXNjb25uZWN0ZWQgcmVhc29uPScsIHJlYXNvbik7XHJcblxyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQocGluZ1RpbWVvdXQpLCBwaW5nVGltZW91dCA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICBpZiAocmVhc29uID09PSBjbGllbnQpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKCdzdG9wJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gZGlzY29ubmVjdCB3YXMgY2FsbGVkIGRpcmVjdGx5LCBkbyBub3QgcmVzdW1lLCBjYW5jZWwgb3V0c3RhbmRpbmdcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXN1bWVUaW1lb3V0KSwgcmVzdW1lVGltZW91dCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzdW1lQXR0ZW1wdHMgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTpzdG9wJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXN1bWVBdHRlbXB0cyA9IDA7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChqaXR0ZXIgPiAwICYmIHJlc3VtZUF0dGVtcHRzID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByYW5kb21pemVkID0gaml0dGVyICogTWF0aC5yYW5kb20oKTtcclxuICAgICAgICAgICAgICAgIGRlYnVnKCdqaXR0ZXIgZmlyc3QgcmVzdW1lIGF0dGVtcHQ9JywgcmFuZG9taXplZCk7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGRvUmVzdW1lKCksIHJhbmRvbWl6ZWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9SZXN1bWUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxufVxyXG4iXX0=