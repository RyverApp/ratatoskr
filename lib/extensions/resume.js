"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var debug = require('debug')('ratatoskr:resume');
var RESUME_STEPS = [200, 1 * 1000, 5 * 1000, 10 * 1000, 30 * 1000, 60 * 1000];
function resume(_a) {
    var _b = _a === void 0 ? {} : _a, _c = _b.ping, ping = _c === void 0 ? 10 * 1000 : _c, _d = _b.retry, retry = _d === void 0 ? 6 : _d, _e = _b.steps, steps = _e === void 0 ? RESUME_STEPS : _e, _f = _b.jitter, jitter = _f === void 0 ? 1800 : _f;
    return function (client) {
        var prevAckAt, thisAckAt;
        var pingTimeout;
        var resumeTimeout;
        var resumeAttempts = 0;
        function doPing() {
            var msg = {};
            client.emit('resume:ping', msg);
            debug('ping=', msg);
            client.sendPing().then(function (ack) {
                debug('pong=', ack);
                prevAckAt = thisAckAt, thisAckAt = Date.now();
                client.emit('resume:pong', ack);
                client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
                pingTimeout = setTimeout(function () { return doPing(); }, ping);
            }, function (err) {
                debug('error=', err);
                if (resumeAttempts === 0) {
                    client.disconnect(new Error('pong'));
                }
            });
        }
        function doResume() {
            resumeAttempts++;
            if (retry > -1 && resumeAttempts > retry) {
                debug('quit');
                client.emit('resume:quit');
                return;
            }
            var resumeDelay = steps[Math.min(resumeAttempts, steps.length) - 1];
            debug('attempt=', resumeAttempts, resumeDelay);
            client.emit('resume', resumeDelay, resumeAttempts);
            clearTimeout(resumeTimeout), resumeTimeout = null;
            resumeTimeout = setTimeout(function () { return client.connect(); }, resumeDelay);
        }
        client.on('authenticated', function () {
            debug('authenticated');
            prevAckAt = thisAckAt || Date.now(), thisAckAt = Date.now();
            client.emit('resume:tick', thisAckAt - prevAckAt, thisAckAt, prevAckAt);
            pingTimeout = setTimeout(function () { return doPing(); }, ping);
            resumeAttempts = 0;
        });
        client.on('disconnected', function (reason) {
            debug('disconnected reason=', reason);
            clearTimeout(pingTimeout), pingTimeout = null;
            if (reason === client) {
                debug('stop');
                clearTimeout(resumeTimeout), resumeTimeout = null;
                if (resumeAttempts > 0) {
                    client.emit('resume:stop');
                }
                resumeAttempts = 0;
                return;
            }
            if (jitter > 0 && resumeAttempts === 0) {
                var randomized = jitter * Math.random();
                debug('jitter first resume attempt=', randomized);
                setTimeout(function () { return doResume(); }, randomized);
            }
            else {
                doResume();
            }
        });
    };
}
exports.resume = resume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2V4dGVuc2lvbnMvcmVzdW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsSUFBTSxLQUFLLEdBQW9CLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3BFLElBQU0sWUFBWSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLEVBQUUsR0FBRyxJQUFJLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBU2hGLGdCQUF1QixFQUF3RjtRQUF4Riw0QkFBd0YsRUFBdEYsWUFBZ0IsRUFBaEIscUNBQWdCLEVBQUUsYUFBUyxFQUFULDhCQUFTLEVBQUUsYUFBb0IsRUFBcEIseUNBQW9CLEVBQUUsY0FBYSxFQUFiLGtDQUFhO0lBQ3JGLE1BQU0sQ0FBQyxVQUFDLE1BQWM7UUFDbEIsSUFBSSxTQUFpQixFQUFFLFNBQWlCLENBQUM7UUFDekMsSUFBSSxXQUFnQixDQUFDO1FBQ3JCLElBQUksYUFBa0IsQ0FBQztRQUN2QixJQUFJLGNBQWMsR0FBVyxDQUFDLENBQUM7UUFFL0I7WUFDSSxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDYixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUVoQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRXBCLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQyxHQUFHO2dCQUN2QixLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUVwQixTQUFTLEdBQUcsU0FBUyxFQUFFLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQzlDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdB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LENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxJQUFNLFVBQVUsR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUMxQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQ2xELFVBQVUsQ0FBQyxjQUFNLE9BQUEsUUFBUSxFQUFFLEVBQVYsQ0FBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzdDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixRQUFRLEVBQUUsQ0FBQztZQUNmLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztBQUNOLENBQUM7QUF4RkQsd0JBd0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSAnLi4vY2xpZW50JztcblxuY29uc3QgZGVidWc6IGRlYnVnLklEZWJ1Z2dlciA9IHJlcXVpcmUoJ2RlYnVnJykoJ3JhdGF0b3NrcjpyZXN1bWUnKTtcbmNvbnN0IFJFU1VNRV9TVEVQUyA9IFsyMDAsIDEgKiAxMDAwLCA1ICogMTAwMCwgMTAgKiAxMDAwLCAzMCAqIDEwMDAsIDYwICogMTAwMF07IC8vIDBzLCAxcywgNXMsIDEwcywgMzBzLCA2MHNcblxuZXhwb3J0IGludGVyZmFjZSBSZXN1bWVPcHRpb25zIHtcbiAgICBwaW5nPzogbnVtYmVyO1xuICAgIHJldHJ5PzogbnVtYmVyO1xuICAgIHN0ZXBzPzogQXJyYXk8bnVtYmVyPjtcbiAgICBqaXR0ZXI/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXN1bWUoeyBwaW5nID0gMTAgKiAxMDAwLCByZXRyeSA9IDYsIHN0ZXBzID0gUkVTVU1FX1NURVBTLCBqaXR0ZXIgPSAxODAwIH06IFJlc3VtZU9wdGlvbnMgPSB7fSkge1xuICAgIHJldHVybiAoY2xpZW50OiBDbGllbnQpID0+IHtcbiAgICAgICAgdmFyIHByZXZBY2tBdDogbnVtYmVyLCB0aGlzQWNrQXQ6IG51bWJlcjtcbiAgICAgICAgdmFyIHBpbmdUaW1lb3V0OiBhbnk7XG4gICAgICAgIHZhciByZXN1bWVUaW1lb3V0OiBhbnk7XG4gICAgICAgIHZhciByZXN1bWVBdHRlbXB0czogbnVtYmVyID0gMDtcblxuICAgICAgICBmdW5jdGlvbiBkb1BpbmcoKSB7XG4gICAgICAgICAgICB2YXIgbXNnID0ge307XG4gICAgICAgICAgICBjbGllbnQuZW1pdCgncmVzdW1lOnBpbmcnLCBtc2cpO1xuXG4gICAgICAgICAgICBkZWJ1ZygncGluZz0nLCBtc2cpO1xuXG4gICAgICAgICAgICBjbGllbnQuc2VuZFBpbmcoKS50aGVuKChhY2spID0+IHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygncG9uZz0nLCBhY2spO1xuXG4gICAgICAgICAgICAgICAgcHJldkFja0F0ID0gdGhpc0Fja0F0LCB0aGlzQWNrQXQgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cG9uZycsIGFjayk7XG4gICAgICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTp0aWNrJywgdGhpc0Fja0F0IC0gcHJldkFja0F0LCB0aGlzQWNrQXQsIHByZXZBY2tBdCk7XG4gICAgICAgICAgICAgICAgcGluZ1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IGRvUGluZygpLCBwaW5nKTtcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBkZWJ1ZygnZXJyb3I9JywgZXJyKTtcblxuICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzb2NrZXQgaXMgY2xvc2VkLCBpdCB3aWxsIHRyaWdnZXIgYSBgZGlzY29ubmVjdGVkYCBldmVudCwgd2hpY2ggd2lsbCBpbiB0dXJuIHRyaWdnZXIgYGRvUmVzdW1lYCwgYW5kIHRoZW4gYW55IG1lc3NhZ2VzXG4gICAgICAgICAgICAgICAgLy8gYXdhaXRpbmcgYWNrbm93bGVkZ2VtZW50IHdpbGwgYmUgcmVqZWN0ZWQuICBJbiB0aGlzIG9yZGVyIG9mIGV2ZW50cywgdGhlIHJlc3VtZSBwcm9jZXNzIGhhcyBhbHJlYWR5IGJlZ3VuLCBzbyB3ZSBkbyBub3Qgd2FudCB0b1xuICAgICAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3QgaGVyZS5cbiAgICAgICAgICAgICAgICBpZiAocmVzdW1lQXR0ZW1wdHMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LmRpc2Nvbm5lY3QobmV3IEVycm9yKCdwb25nJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZG9SZXN1bWUoKSB7XG4gICAgICAgICAgICByZXN1bWVBdHRlbXB0cysrO1xuXG4gICAgICAgICAgICBpZiAocmV0cnkgPiAtMSAmJiByZXN1bWVBdHRlbXB0cyA+IHJldHJ5KSB7XG4gICAgICAgICAgICAgICAgZGVidWcoJ3F1aXQnKTtcblxuICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6cXVpdCcpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHJlc3VtZURlbGF5ID0gc3RlcHNbTWF0aC5taW4ocmVzdW1lQXR0ZW1wdHMsIHN0ZXBzLmxlbmd0aCkgLSAxXTtcblxuICAgICAgICAgICAgZGVidWcoJ2F0dGVtcHQ9JywgcmVzdW1lQXR0ZW1wdHMsIHJlc3VtZURlbGF5KTtcblxuICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZScsIHJlc3VtZURlbGF5LCByZXN1bWVBdHRlbXB0cyk7XG5cbiAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXN1bWVUaW1lb3V0KSwgcmVzdW1lVGltZW91dCA9IG51bGw7XG5cbiAgICAgICAgICAgIHJlc3VtZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IGNsaWVudC5jb25uZWN0KCksIHJlc3VtZURlbGF5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNsaWVudC5vbignYXV0aGVudGljYXRlZCcsICgpID0+IHtcbiAgICAgICAgICAgIGRlYnVnKCdhdXRoZW50aWNhdGVkJyk7XG5cbiAgICAgICAgICAgIHByZXZBY2tBdCA9IHRoaXNBY2tBdCB8fCBEYXRlLm5vdygpLCB0aGlzQWNrQXQgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgY2xpZW50LmVtaXQoJ3Jlc3VtZTp0aWNrJywgdGhpc0Fja0F0IC0gcHJldkFja0F0LCB0aGlzQWNrQXQsIHByZXZBY2tBdCk7XG4gICAgICAgICAgICBwaW5nVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gZG9QaW5nKCksIHBpbmcpO1xuICAgICAgICAgICAgcmVzdW1lQXR0ZW1wdHMgPSAwO1xuICAgICAgICB9KTtcblxuICAgICAgICBjbGllbnQub24oJ2Rpc2Nvbm5lY3RlZCcsIChyZWFzb24pID0+IHtcbiAgICAgICAgICAgIGRlYnVnKCdkaXNjb25uZWN0ZWQgcmVhc29uPScsIHJlYXNvbik7XG5cbiAgICAgICAgICAgIGNsZWFyVGltZW91dChwaW5nVGltZW91dCksIHBpbmdUaW1lb3V0ID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKHJlYXNvbiA9PT0gY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgZGVidWcoJ3N0b3AnKTtcblxuICAgICAgICAgICAgICAgIC8vIGRpc2Nvbm5lY3Qgd2FzIGNhbGxlZCBkaXJlY3RseSwgZG8gbm90IHJlc3VtZSwgY2FuY2VsIG91dHN0YW5kaW5nXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlc3VtZVRpbWVvdXQpLCByZXN1bWVUaW1lb3V0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAocmVzdW1lQXR0ZW1wdHMgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudC5lbWl0KCdyZXN1bWU6c3RvcCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bWVBdHRlbXB0cyA9IDA7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaml0dGVyID4gMCAmJiByZXN1bWVBdHRlbXB0cyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJhbmRvbWl6ZWQgPSBqaXR0ZXIgKiBNYXRoLnJhbmRvbSgpO1xuICAgICAgICAgICAgICAgIGRlYnVnKCdqaXR0ZXIgZmlyc3QgcmVzdW1lIGF0dGVtcHQ9JywgcmFuZG9taXplZCk7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkb1Jlc3VtZSgpLCByYW5kb21pemVkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZG9SZXN1bWUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfTtcbn1cbiJdfQ==